blueprint:
  name: GoodWe & Tibber Smart Charge (Optimiert)
  description: |
    **Intelligente Batteriesteuerung für GoodWe Wechselrichter mit Tibber**
    
    Dieses Blueprint optimiert deinen Speicher vollautomatisch, um Stromkosten zu senken und den Eigenverbrauch zu maximieren.

    **Funktionsweise:**
    1. **Günstiges Laden:** Der Akku wird in den **X günstigsten Stunden** des Tages (basierend auf Tibber-Preisen für heute & morgen) aus dem Netz geladen (Modus: Backup).
    2. **Intelligente Zurückhaltung:** Wenn für die günstigen Stunden genug **Solarstrom vorhergesagt** ist (über optionalen Forecast-Sensor) oder aktuell die Sonne scheint, wird das Netzladen übersprungen, um kostenlosen Solarstrom zu nutzen.
    3. **Export-Management:** Im Eigenverbrauchsmodus (General) wird die **Exportsperre** automatisch aktiviert, wenn der Akku entladen wird (um Netzbezug/Verluste zu minimieren), und deaktiviert, wenn der Akku voll ist (um Überschuss einzuspeisen).

    **Voraussetzungen:**
    * **HACS GoodWe Integration:** Für die Steuerung von Modus & Exportsperre.
    * **Tibber Daten-Sensor:** Ein manuell angelegter Template/REST-Sensor, der die Attribute `today` und `tomorrow` liefert (siehe Anleitung).
    * **(Optional) Solar Forecast:** Ein Sensor von `ha-solar-forecast-ml` o.ä. für noch präzisere Entscheidungen.

  domain: automation
  input:
    tibber_price_data_sensor:
      name: Tibber Preisdaten Sensor
      description: >
        Der Sensor, der die stündlichen Preise als Attribute 'today' und 'tomorrow' enthält.
        (Meistens ein manuell erstellter REST-Sensor in der configuration.yaml).
      selector:
        entity:
          domain: sensor
    pv_power_sensor:
      name: Aktuelle PV-Leistung (W)
      description: Sensor für die aktuelle Erzeugung des Wechselrichters (z.B. sensor.goodwe_pv_power).
      selector:
        entity:
          domain: sensor
          device_class: power
    battery_soc_sensor:
      name: Batterie Ladestand (%)
      description: Sensor für den aktuellen SOC der Batterie (z.B. sensor.goodwe_battery_soc).
      selector:
        entity:
          domain: sensor
          device_class: battery
    goodwe_work_mode_selector:
      name: GoodWe Betriebsmodus Selector
      description: >
        Die Entität zum Umschalten des Modus (z.B. select.goodwe_work_mode). 
        Muss Optionen wie 'General' und 'Backup' haben.
      selector:
        entity:
          domain: select
    goodwe_export_limit_switch:
      name: GoodWe Exportsperre Schalter
      description: >
        Der Schalter zum Ein-/Ausschalten der Einspeisebegrenzung (z.B. switch.goodwe_export_limit).
      selector:
        entity:
          domain: switch
    solar_forecast_sensor:
      name: Solar Prognose Sensor (Optional)
      description: >
        Ein Sensor, der die erwartete Solarleistung in Watt liefert. 
        Wenn nicht vorhanden, wird nur die aktuelle PV-Leistung berücksichtigt.
      default: null
      selector:
        entity:
          domain: sensor
    charge_hours:
      name: Ladedauer in Stunden
      description: >
        Anzahl der günstigsten Stunden, in denen geladen werden soll.
        Faustformel: Batteriekapazität (kWh) / Ladeleistung (kW) = Stunden (aufgerundet).
      default: 3
      selector:
        number:
          min: 1
          max: 8
          unit_of_measurement: "Stunden"
    pv_threshold_low:
      name: PV-Schwellenwert Niedrig (W)
      description: >
        Unterhalb dieses Wertes gilt - Keine nennenswerte Sonne.
        Wird genutzt, um Netzladen zu erlauben oder Exportsperre zu aktivieren.
      default: 50
      selector:
        number:
          min: 0
          unit_of_measurement: "W"
    pv_threshold_high:
      name: PV-Schwellenwert Hoch (W)
      description: >
        Oberhalb dieses Wertes gilt - Viel Überschuss.
        Wird genutzt, um die Exportsperre bei vollem Akku freizugeben.
      default: 50
      selector:
        number:
          min: 0
          unit_of_measurement: "W"
    soc_full_threshold:
      name: Batterie Voll-Schwellenwert (%)
      description: Ab diesem Ladestand gilt der Akku als voll und das Netzladen stoppt.
      default: 99
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

mode: single
max_exceeded: silent

trigger:
  - platform: time_pattern
    minutes: "*"
  - platform: homeassistant
    event_type: state_changed
    entity_id:
      - !input pv_power_sensor
      - !input battery_soc_sensor
      - !input goodwe_work_mode_selector
      - !input goodwe_export_limit_switch
      - !input solar_forecast_sensor
      - !input tibber_price_data_sensor

variables:
  # Inputs mappen
  v_tibber_sensor: !input tibber_price_data_sensor
  v_pv_power_sensor: !input pv_power_sensor
  v_battery_soc_sensor: !input battery_soc_sensor
  v_work_mode_selector: !input goodwe_work_mode_selector
  v_export_limit_switch: !input goodwe_export_limit_switch
  v_solar_forecast_sensor: !input solar_forecast_sensor
  
  # Einstellungen holen (mit Fallback)
  v_charge_hours: "{{ iif(states(v_charge_hours) is defined and states(v_charge_hours) | is_number, states(v_charge_hours) | int, 3) }}"
  v_pv_threshold_low: "{{ iif(states(v_pv_threshold_low) is defined and states(v_pv_threshold_low) | is_number, states(v_pv_threshold_low) | int, 50) }}"
  v_pv_threshold_high: "{{ iif(states(v_pv_threshold_high) is defined and states(v_pv_threshold_high) | is_number, states(v_pv_threshold_high) | int, 50) }}"
  v_soc_full_threshold: "{{ iif(states(v_soc_full_threshold) is defined and states(v_soc_full_threshold) | is_number, states(v_soc_full_threshold) | int, 99) }}"
  
  # Aktuelle Werte
  pv_leistung: "{{ states(v_pv_power_sensor) | float(0) }}"
  batterie_soc: "{{ states(v_battery_soc_sensor) | float(100) }}"
  aktueller_modus: "{{ states(v_work_mode_selector) }}"
  export_limit_active: "{{ is_state(v_export_limit_switch, 'on') }}"
  
  # Solar Prognose Logik
  solar_forecast_value: >
    {% set forecast_state = states(v_solar_forecast_sensor) %}
    {% if forecast_state is not none and forecast_state not in ['unavailable', 'unknown', 'none', 'null', ''] %}
      {{ forecast_state | float(0) }}
    {% else %}
      {{ 0 }}
    {% endif %}

  # Tibber Preis Logik
  current_time: "{{ now() }}"
  tibber_raw_prices: "{{ state_attr(v_tibber_sensor, 'home').currentSubscription.priceInfo if
